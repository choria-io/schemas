{
    "$schema": "http://json-schema.org/draft-04/schema",
    "id": "https://choria.io/schemas/choria/machine/v1/manifest.json",
    "description": "Choria Autonomous Agent manifest",
    "type":"object",
    "required":["name","version","initial_state","transitions","watchers"],
    "definitions": {
        "GoDuration": {
            "type":"string",
            "pattern": "^\\d+\\[hms\\]$"
        },
        "GenericName": {
            "type":"string",
            "pattern":"^[a-zA-Z][a-zA-Z0-9_-]+$"
        },
        "EnvironmentVariable": {
            "type":"string",
            "description": "Environment variable as accepted by Go exec package",
            "pattern": "^[a-zA-Z_]+[a-zA-Z0-9_]*=.+"
        },
        "Transition": {
            "type":"object",
            "required": ["name", "from", "destination"],
            "additionalItems": false,
            "description": "A valid transition of the Finite State Machine",
            "properties": {
                "name": {
                    "description": "A unique name for the transition event",
                    "$ref":"#/definitions/GenericName"
                },
                "from": {
                    "description": "The names of states that this transition is valid from",
                    "type":"array",
                    "items": {
                        "$ref":"#/definitions/GenericName"
                    }
                },
                "destination": {
                    "description": "The name of the state to transition to when this event fires",
                    "$ref":"#/definitions/GenericName"
                }
            }
        },
        "WatcherBase": {
            "type":"object",
            "required": ["name", "type"],
            "additionalItems": false,
            "properties": {
                "name": {
                    "description": "The name of the watcher",
                    "$ref":"#/definitions/GenericName"
                },
                "state_match": {
                    "description": "State names where this watcher will be active",
                    "type":"array",
                    "items": {
                        "$ref":"#/definitions/GenericName"
                    }
                },
                "fail_transition": {
                    "description": "When this watcher fails the machine will receive this transition event",
                    "$ref":"#/definitions/GenericName"
                },
                "success_transition": {
                    "description": "When this watcher succeeds the machine will receive this transition event",
                    "$ref":"#/definitions/GenericName"
                },
                "interval": {
                    "description": "How often this watcher will be run when in any of the valid states",
                    "$ref":"#/definitions/GoDuration"
                },
                "announce_interval": {
                    "description": "How often the internal state of the watcher will be announced as events",
                    "$ref":"#/definitions/GoDuration"
                }
            }
        },
        "WatcherFileProperties": {
            "type":"object",
            "description": "File watcher properties",
            "required": ["path"],
            "properties": {
                "path": {
                    "type": "string",
                    "description": "The path to a file to watch relative to the machine root"
                },
                "gather_initial_state": {
                    "type":"boolean",
                    "description": "If the properties of the file should be gathered on initial load"
                }
            }
        },
        "WatcherFile": {
            "description": "A watcher that observes the state of a file regularly",
            "type": "object",
            "additionalItems": false,
            "allOf": [
                {
                    "type":"object",
                    "required": ["type"],
                    "properties": {
                        "type": {
                            "enum": ["file"]
                        }
                    }
                },
                {"$ref":"#/definitions/WatcherBase"},
                {
                    "type":"object",
                    "required": ["properties"],
                    "properties": {
                        "properties": { "$ref":"#/definitions/WatcherFileProperties" }
                    }
                }
            ]
        },
        "WatcherExecProperties": {
            "type":"object",
            "description": "Exec watcher properties",
            "required": ["command"],
            "properties": {
                "command": {
                    "type": "string",
                    "description": "The path to a command to run relative to the machine root"
                },
                "timeout": {
                    "description": "How long the commands are allowed to run",
                    "default": "10s",
                    "$ref":"#/definitions/GoDuration"
                },
                "suppress_success_announce": {
                    "description": "Disable publishing announcements on every successful execution, still does regular timed ones if configured and failed ones",
                    "default": false,
                    "type":"boolean"
                },
                "environment": {
                    "description": "List of environment variables to pass to the executable in the form VAR=VALUE",
                    "default": [],
                    "type":"array",
                    "items":  { "$ref":"#/definitions/EnvironmentVariable" }
                }
            }
        },
        "WatcherExec": {
            "description": "A watcher that executes a command regularly",
            "type": "object",
            "additionalItems": false,
            "allOf": [
                {
                    "type":"object",
                    "required": ["properties"],
                    "properties": {
                        "properties": { "$ref":"#/definitions/WatcherExecProperties" }
                    }
                },
                {"$ref":"#/definitions/WatcherBase"},
                {
                    "type":"object",
                    "required": ["type"],
                    "properties": {
                        "type": {
                            "enum": ["exec"]
                        }
                    }
                }
            ]
        },
        "WatcherScheduleProperties": {
            "type":"object",
            "description": "Schedule watcher properties",
            "required": ["duration", "schedules"],
            "properties": {
                "duration": {
                    "description": "How long the scheduler should stay in the success state once triggered",
                    "$ref":"#/definitions/GoDuration"
                },
                "schedules": {
                    "description": "Cron like schedules for when the scheduler trigger success states",
                    "type":"array",
                    "items": {
                        "type":"string"
                    }
                }
            }
        },
        "WatcherSchedule": {
            "description": "A watcher that triggers transitions based on a set of cron like schedules",
            "type":"object",
            "additionalItems": false,
            "allOf": [
                {
                    "type":"object",
                    "required":["properties"],
                    "properties": {
                        "properties": { "$ref":"#/definitions/WatcherScheduleProperties" }
                    }
                },
                {"$ref":"#/definitions/WatcherBase"},
                {
                    "type":"object",
                    "required": ["type"],
                    "properties": {
                        "type": {
                            "enum": ["schedule"]
                        }
                    }
                }
            ]
        }
    },
    "properties": {
        "name": {
            "description": "A unique name for this autonomous agent",
            "$ref":"#/definitions/GenericName"
        },
        "version": {
            "type":"string",
            "description": "SemVer compatible version of the autonomous agent",
            "minLength": 5,
            "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "initial_state": { "$ref":"#/definitions/GenericName" },
        "splay_start": {
            "type":"integer",
            "description": "Causes a random delay on start no longer than splay_start seconds",
            "default":0
        },
        "transitions": {
            "type":"array",
            "description": "A list of events that can be fired for this autonomous agent",
            "minItems": 1,
            "items": { "$ref":"#/definitions/Transition" }
        },
        "watchers": {
            "description": "Watchers to observe the environment in specific states",
            "type":"array",
            "minItems": 1,
            "items": {
                "anyOf": [
                    {"$ref":"#/definitions/WatcherFile"},
                    {"$ref":"#/definitions/WatcherExec"},
                    {"$ref":"#/definitions/WatcherSchedule"}
                ]
            }
        }
    }
}